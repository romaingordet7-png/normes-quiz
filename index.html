<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDN : Mode Survie</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --danger: #ef4444;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #0f172a;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container { max-width: 600px; width: 100%; }

        /* Score Board */
        .score-board {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .score-box {
            background: white;
            padding: 10px 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            text-align: center;
        }
        .score-val { font-size: 1.5em; display: block; }
        .streak-fire { color: orange; }

        /* Card Styles */
        .card {
            background: var(--card);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            transition: transform 0.2s, background-color 0.2s;
        }

        h3 { margin-top: 0; color: var(--primary); }
        .unit-badge {
            background: #e0f2fe; color: #0369a1;
            padding: 4px 8px; border-radius: 6px; font-size: 0.9em; font-weight: 600;
        }

        /* Inputs */
        .input-group { margin-bottom: 15px; }
        .input-label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em; color: #64748b; }
        input[type="text"] {
            width: 100%;
            padding: 14px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 18px;
            outline: none;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus { border-color: var(--primary); }

        /* Buttons */
        button {
            width: 100%;
            padding: 15px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover { filter: brightness(110%); }
        .btn-next { background-color: var(--text); display: none; }

        /* Feedback Visuals */
        .feedback {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }
        .feedback.success { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .feedback.error { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }

        /* ANIMATIONS AGRESSIVES */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        .shake-animation {
            animation: shake 0.5s;
            border: 2px solid var(--danger) !important;
            box-shadow: 0 0 20px rgba(220, 38, 38, 0.3);
        }

        .hidden { display: none; }
        
        /* DB Editor */
        #db-editor { margin-top: 50px; border-top: 1px dashed #ccc; padding-top: 20px; }
        textarea { width: 100%; height: 100px; font-family: monospace; }
    </style>
</head>
<body>

<div class="container">
    
    <div class="score-board">
        <div class="score-box">
            <span>üî• S√©rie actuelle</span>
            <span class="score-val streak-fire" id="current-streak">0</span>
        </div>
        <div class="score-box">
            <span>üèÜ Record</span>
            <span class="score-val" id="high-score">0</span>
        </div>
    </div>

    <div id="quiz-card" class="card">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <small id="q-cat" style="color:#64748b; font-weight:bold; text-transform:uppercase;">Cat√©gorie</small>
        </div>
        
        <h3 id="q-title">Chargement...</h3>
        <span class="unit-badge" id="q-unit">Unit√©</span>
        <p style="font-size:0.9em; color:#666; margin-bottom:20px;">Entrez les valeurs (tol√©rance 1%)</p>

        <div id="dynamic-inputs"></div>

        <button id="btn-validate" onclick="validateAnswer()">VALIDER</button>
        <button id="btn-continue" class="btn-next" onclick="nextQuestion()">CONTINUER ‚ûî</button>

        <div id="feedback-msg" class="feedback"></div>
    </div>

    <div id="db-editor">
        <button onclick="document.getElementById('editor-area').classList.toggle('hidden')" style="background:#64748b; font-size:14px; padding:8px;">‚öôÔ∏è Modifier la base (JSON)</button>
        <div id="editor-area" class="hidden">
            <p>Format : <code>"targets": [nombre1, nombre2]</code>. Pour les intervalles, mettez les deux bornes.</p>
            <textarea id="json-input"></textarea>
            <button onclick="saveData()" style="background:#16a34a;">Sauvegarder</button>
        </div>
    </div>

</div>

<script>
    // --- NOUVELLE STRUCTURE DE DONN√âES ---
    // "targets" contient les chiffres que le syst√®me va chercher dans la r√©ponse.
    // Si "inputs" contient plusieurs objets, on affiche plusieurs cases.
    
    const defaultData = [
        // COMPLEXE (H/F)
        { 
            cat: "H√©matologie", param: "H√©moglobine (Hb)", unit: "g/dL", 
            inputs: [
                { label: "Homme", targets: [13, 18] },
                { label: "Femme", targets: [12, 16] }
            ],
            info: "Femme enceinte T2 > 10.5. Transfusion < 7."
        },
        { 
            cat: "Rhumatologie", param: "Acide Urique", unit: "¬µmol/L", 
            inputs: [
                { label: "Homme", targets: [180, 420] },
                { label: "Femme", targets: [150, 360] }
            ],
            info: "Seuil de saturation = 420 (68 mg/L)"
        },
        { 
            cat: "Fer & Vitamines", param: "Ferritine", unit: "¬µg/L", 
            inputs: [
                { label: "Homme", targets: [30, 300] },
                { label: "Femme", targets: [15, 200] }
            ],
            info: "Carence < 15. Inflammatoire > 100."
        },

        // SIMPLE (Une seule case)
        { cat: "H√©matologie", param: "VGM", unit: "fL", inputs: [{ label: "Valeur", targets: [80, 100] }], info: "Micro < 80, Macro > 100" },
        { cat: "H√©matologie", param: "Plaquettes", unit: "G/L", inputs: [{ label: "Valeur", targets: [150, 400] }], info: "Thrombop√©nie < 150" },
        { cat: "H√©matologie", param: "Leucocytes", unit: "G/L", inputs: [{ label: "Valeur", targets: [4, 10] }], info: "" },
        { cat: "H√©matologie", param: "PNN", unit: "G/L", inputs: [{ label: "Valeur", targets: [1.5, 7] }], info: "Agranulocytose < 0.5" },
        
        { cat: "H√©mostase", param: "TP", unit: "%", inputs: [{ label: "Valeur", targets: [70, 100] }], info: "Insuffisance h√©patique < 50%" },
        { cat: "H√©mostase", param: "Fibrinog√®ne", unit: "g/L", inputs: [{ label: "Valeur", targets: [2, 4] }], info: "" },
        
        { cat: "Ionogramme", param: "Sodium (Natr√©mie)", unit: "mmol/L", inputs: [{ label: "Valeur", targets: [135, 145] }], info: "Hyponatr√©mie grave < 120" },
        { cat: "Ionogramme", param: "Potassium (Kali√©mie)", unit: "mmol/L", inputs: [{ label: "Valeur", targets: [3.5, 4.5] }], info: "Parfois 5.0 max selon labo" },
        { cat: "Ionogramme", param: "Calcium Total", unit: "mmol/L", inputs: [{ label: "Valeur", targets: [2.20, 2.60] }], info: "Hypercalc√©mie mena√ßante > 3.0" },
        { cat: "Ionogramme", param: "Bicarbonates", unit: "mmol/L", inputs: [{ label: "Valeur", targets: [22, 28] }], info: "" },
        
        { cat: "N√©phrologie", param: "Cr√©atinine", unit: "¬µmol/L", inputs: [{ label: "Valeur", targets: [60, 110] }], info: "D√©pend masse musculaire" },
        { cat: "N√©phrologie", param: "DFG (Normal)", unit: "mL/min", inputs: [{ label: "Seuil", targets: [90] }], info: "IRC < 60" },
        
        { cat: "M√©tabolisme", param: "Glyc√©mie √† jeun", unit: "g/L", inputs: [{ label: "Valeur", targets: [0.70, 1.10] }], info: "Diab√®te >= 1.26" },
        { cat: "M√©tabolisme", param: "HbA1c (Normale)", unit: "%", inputs: [{ label: "Valeur", targets: [4, 6] }], info: "Diab√®te >= 6.5%" },
        { cat: "M√©tabolisme", param: "Cholest√©rol Total", unit: "g/L", inputs: [{ label: "Seuil max", targets: [2.0] }], info: "" },
        { cat: "M√©tabolisme", param: "HDL Cholest√©rol", unit: "g/L", inputs: [{ label: "Seuil min", targets: [0.40] }], info: "Protecteur > 0.60" },
        
        { cat: "Inflammation", param: "CRP", unit: "mg/L", inputs: [{ label: "Seuil", targets: [5] }], info: "Parfois < 10 selon labo" },
        { cat: "Cardio", param: "BNP", unit: "ng/L", inputs: [{ label: "Seuil exclusion", targets: [100] }], info: "" },
        
        { cat: "GDS", param: "pH", unit: "-", inputs: [{ label: "Valeur", targets: [7.38, 7.42] }], info: "" },
        { cat: "GDS", param: "PaO2", unit: "mmHg", inputs: [{ label: "Valeur", targets: [80, 100] }], info: "Hypox√©mie < 80" },
        { cat: "GDS", param: "PaCO2", unit: "mmHg", inputs: [{ label: "Valeur", targets: [38, 42] }], info: "" },
        
        { cat: "Endocrino", param: "TSH", unit: "mUI/L", inputs: [{ label: "Valeur", targets: [0.4, 4.0] }], info: "" },
        { cat: "Endocrino", param: "Vitamine D", unit: "ng/mL", inputs: [{ label: "Valeur", targets: [30, 60] }], info: "Carence < 10" },
        
        { cat: "Liquides", param: "LCR (Leucocytes)", unit: "Elts/mm¬≥", inputs: [{ label: "Seuil", targets: [5] }], info: "Parfois < 10" },
        { cat: "Liquides", param: "Liquide Articulaire", unit: "Elts/mm¬≥", inputs: [{ label: "Seuil Inflam.", targets: [2000] }], info: "Septique > 50 000" }
    ];

    // --- VARIABLES ---
    let questions = [];
    let currentQ = null;
    let streak = 0;
    let highScore = localStorage.getItem('edn_highscore') || 0;

    // --- INITIALISATION ---
    window.onload = function() {
        // Charger donn√©es
        const stored = localStorage.getItem('edn_db_v2');
        if (stored) {
            questions = JSON.parse(stored);
        } else {
            questions = defaultData;
        }
        
        // Afficher High Score
        document.getElementById('high-score').innerText = highScore;
        document.getElementById('json-input').value = JSON.stringify(questions, null, 2);
        
        // Lancer
        nextQuestion();
    };

    function nextQuestion() {
        // Reset UI
        document.getElementById('quiz-card').classList.remove('shake-animation');
        document.getElementById('btn-validate').style.display = 'block';
        document.getElementById('btn-continue').style.display = 'none';
        document.getElementById('feedback-msg').style.display = 'none';
        document.getElementById('feedback-msg').className = 'feedback';
        document.getElementById('dynamic-inputs').innerHTML = '';

        // Pick Random
        currentQ = questions[Math.floor(Math.random() * questions.length)];
        
        // Render
        document.getElementById('q-cat').innerText = currentQ.cat;
        document.getElementById('q-title').innerText = currentQ.param;
        document.getElementById('q-unit').innerText = currentQ.unit;

        // Generate Inputs
        const container = document.getElementById('dynamic-inputs');
        currentQ.inputs.forEach((inp, index) => {
            const group = document.createElement('div');
            group.className = 'input-group';
            
            const label = document.createElement('label');
            label.className = 'input-label';
            label.innerText = inp.label;
            
            const field = document.createElement('input');
            field.type = 'text';
            field.id = `input-${index}`;
            field.placeholder = 'ex: 135 - 145';
            field.autocomplete = 'off';
            
            // Allow Enter key to validate
            field.addEventListener("keypress", function(event) {
                if (event.key === "Enter") validateAnswer();
            });

            group.appendChild(label);
            group.appendChild(field);
            container.appendChild(group);
        });

        // Focus first input
        setTimeout(() => document.getElementById('input-0').focus(), 100);
    }

    // --- MOTEUR DE VALIDATION ---
    function validateAnswer() {
        let allCorrect = true;
        let correctionHTML = "";

        // Pour chaque champ de r√©ponse (ex: Homme puis Femme)
        currentQ.inputs.forEach((inp, index) => {
            const userValStr = document.getElementById(`input-${index}`).value;
            const userNumbers = extractNumbers(userValStr); // Array de nombres extraits
            const targets = inp.targets; // Array de nombres attendus
            
            // Logic: Tous les nombres attendus doivent √™tre trouv√©s dans la r√©ponse utilisateur (avec tol√©rance)
            // Si targets = [135, 145], l'user doit avoir tap√© deux nombres proches de √ßa.
            // Si targets = [5], l'user doit avoir tap√© un nombre proche de 5.
            
            let fieldCorrect = false;
            
            if (userNumbers.length >= targets.length) {
                // On v√©rifie si chaque target a un "match" dans les inputs user
                let matchesFound = 0;
                targets.forEach(t => {
                    const match = userNumbers.find(u => isCloseEnough(u, t));
                    if (match !== undefined) matchesFound++;
                });
                
                if (matchesFound === targets.length) fieldCorrect = true;
            }

            if (!fieldCorrect) allCorrect = false;
            
            // Pr√©parer correction
            correctionHTML += `<div><strong>${inp.label} :</strong> Attendu <b>${targets.join(' - ')}</b></div>`;
        });

        handleResult(allCorrect, correctionHTML);
    }

    // Extrait les nombres flottants d'une chaine (g√®re virgule et point)
    function extractNumbers(str) {
        if (!str) return [];
        const normalized = str.replace(',', '.');
        // Regex pour trouver les nombres (positifs ou n√©gatifs, d√©cimaux)
        const matches = normalized.match(/-?\d+(\.\d+)?/g);
        return matches ? matches.map(Number) : [];
    }

    // V√©rifie tol√©rance 1%
    function isCloseEnough(val, target) {
        if (target === 0) return Math.abs(val) < 0.1;
        const diff = Math.abs(val - target);
        const tolerance = Math.abs(target * 0.01);
        return diff <= tolerance; // ou tolerance minime
    }

    function handleResult(isSuccess, details) {
        const fb = document.getElementById('feedback-msg');
        fb.style.display = 'block';

        if (isSuccess) {
            // SUCCESS
            streak++;
            document.getElementById('current-streak').innerText = streak;
            if (streak > highScore) {
                highScore = streak;
                localStorage.setItem('edn_highscore', highScore);
                document.getElementById('high-score').innerText = highScore;
            }
            
            fb.className = 'feedback success';
            fb.innerHTML = `<strong>‚úÖ Correct !</strong><br>${currentQ.info}`;
            
            // Passer direct √† la suite apr√®s 1s ou bouton ?
            // User veut valider auto. On affiche bouton continuer.
            
        } else {
            // ERROR
            streak = 0;
            document.getElementById('current-streak').innerText = 0;
            
            // Animation Agressive
            document.getElementById('quiz-card').classList.add('shake-animation');
            
            fb.className = 'feedback error';
            fb.innerHTML = `<strong>‚ùå Erreur !</strong><br>${details}<br><em>Note : ${currentQ.info}</em>`;
        }

        // Switch Buttons
        document.getElementById('btn-validate').style.display = 'none';
        document.getElementById('btn-continue').style.display = 'block';
        document.getElementById('btn-continue').focus();
    }

    // --- DB MANAGEMENT ---
    function saveData() {
        try {
            const txt = document.getElementById('json-input').value;
            const json = JSON.parse(txt);
            localStorage.setItem('edn_db_v2', JSON.stringify(json));
            alert("Base sauvegard√©e !");
            location.reload();
        } catch(e) {
            alert("Erreur JSON : " + e);
        }
    }

</script>
</body>
</html>
